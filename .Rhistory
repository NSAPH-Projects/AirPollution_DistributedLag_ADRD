code_type, "_pm25_clean.fst")))
no2_dat <- as.matrix(read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_no2_clean.fst")))
ozone_dat <- as.matrix(read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_ozone_clean.fst")))
##### Exposure dist #####
id10 <- which(qid_dat$year == 2010)
# [1] 10.32589
quantile(pm25_dat[id10,1:10], c(0.001, 0.1, 0.25, 0.5, 0.75, 0.9))
# 0.5%       10%       25%       50%       75%       90%
#   3.072985  7.284397  9.459429 11.537295 13.496358 15.046672
quantile(no2_dat[id10,1:10], c(0.001, 0.1, 0.25, 0.5, 0.75, 0.9))
# 0.5%       10%       25%       50%       75%       90%
#   4.023855  8.810723 12.948049 19.822834 28.940948 37.308495
quantile(ozone_dat[id10,1:10], c(0.001, 0.1, 0.25, 0.5, 0.75, 0.9))
# [1] 10.32589
quantile(pm25_dat[,1:10], c(0.001, 0.1, 0.25, 0.5, 0.75, 0.9))
ggplot(exp_dt[quantile != "NAAQS" & quantile != "AQG" & quantile != "10%"]) +
geom_hline(yintercept = 1, color = "black", size = 1) +
# geom_ribbon(aes(x = lag, ymin = RRlow, ymax = RRhigh, fill = quantile), alpha = 0.3) +
geom_line(aes(x = lag, y = RR, color = quantile, linetype = quantile), size = 2) +
facet_grid( ~ exp) +
theme_bw(base_size = 32) +
theme(legend.position = "bottom", legend.key.width = unit(1, "cm")) +
scale_x_continuous(breaks = 1:10, minor_breaks = NULL, expand = c(0.05, 0)) +
# scale_y_continuous(expand = c(0, 0), limits = c(0.96, 1.13)) +
labs(x = "Years prior", y = "Hazard odds",
color = "", linetype = "", fill = "") +
theme(legend.position = c(0.93, 0.82),
legend.background = element_blank(),
legend.key.height = unit(1, "cm"),
legend.key.width = unit(2.5, "cm"))
summary(exp_dat[id10, 1:10])
summary(c(pm25_dat[id10,1:10]))
summary(c(no2_dat[id10,1:10]))
summary(c(ozone_dat[id10,1:10]))
pred_k <- sort(c(pm25 = 5, no2 = 10, ozone = 60, epa_pm25 = 12, epa_no2 = 53, epa_ozone = 70,
quantile(exp_dat[id10, 1:10], c(0, .1, .25, .5, .75, .9, 1))))
pred_k
cp_dlnm_005 <- crosspred(cb_dlnm, m3, cen = pred_k["0%"], at = pred_k, bylag = 0.2)
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005,"overall")
abline(v=60)
abline(v=70)
pred_k <- sort(c(pm25 = 5, no2 = 10, ozone = 60, epa_pm25 = 12, epa_no2 = 53, epa_ozone = 70,
quantile(exp_dat[id10, 1:10], c(0.05, .1, .25, .5, .75, .9, .995))))
cp_dlnm_005 <- crosspred(cb_dlnm, m3, cen = pred_k["5%"], at = pred_k, bylag = 0.2)
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005,"overall")
pred_k <- sort(c(pm25 = 5, no2 = 10, ozone = 60, epa_pm25 = 12, epa_no2 = 53, epa_ozone = 70,
quantile(exp_dat[id10, 1:10], c(0, .1, .25, .5, .75, .9, 1))))
cp_dlnm_005 <- crosspred(cb_dlnm, m3, cen = pred_k["0%"], at = pred_k, bylag = 0.2)
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005,"slice",var=pred_k[5])
plot(cp_dlnm_005,"slice",var=pred_k[6])
plot(cp_dlnm_005,"slice",var=pred_k[7])
plot(cp_dlnm_005,"slice",var=pred_k[8])
plot(cp_dlnm_005,"slice",var=pred_k[10])
plot(cp_dlnm_005,"slice",var=pred_k[11])
plot(cp_dlnm_005,"slice",var=pred_k[12])
pred_k <- sort(c(pm25 = 5, no2 = 10, ozone = 60, epa_pm25 = 12, epa_no2 = 53, epa_ozone = 70,
quantile(exp_dat[id10, 1:10],
c(0, 0.005, 0.05, .1, .25, .5, .75, .9, 1))))
cp_dlnm_50 <- crosspred(cb_dlnm, m3, cen = pred_k["50%"], at = pred_k, bylag = 0.2)
cp_dlnm_10 <- crosspred(cb_dlnm, m3, cen = pred_k["10%"], at = pred_k, bylag = 0.2)
cp_dlnm_5 <- crosspred(cb_dlnm, m3, cen = pred_k["5%"], at = pred_k, bylag = 0.2)
cp_dlnm_005 <- crosspred(cb_dlnm, m3, cen = pred_k["0.5%"], at = pred_k, bylag = 0.2)
cp_dlnm_0 <- crosspred(cb_dlnm, m3, cen = pred_k["0%"], at = pred_k, bylag = 0.2)
cp_dlnm_who <- crosspred(cb_dlnm, m3, cen = pred_k[exp], at = pred_k, bylag = 0.2)
cp_dlnm_epa <- crosspred(cb_dlnm, m3, cen = pred_k[paste0("epa_", exp)], at = pred_k, bylag = 0.2)
plot(cp_dlnm_0, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_5, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_5,"slice",var=pred_k[8])
plot(cp_dlnm_5,"slice",var=pred_k[7])
plot(cp_dlnm_5,"slice",var=pred_k[6])
plot(cp_dlnm_5,"slice",var=pred_k[])
plot(cp_dlnm_5,"slice",var=pred_k[5])
plot(cp_dlnm_5,"slice",var=pred_k[9])
pred_k
plot(cp_dlnm_5,"slice",var=pred_k[10])
dev.off()
plot(cp_dlnm_5,"slice",var=pred_k[10])
plot(cp_dlnm_5,"slice",var=pred_k[12])
plot(cp_dlnm_5,"slice",var=pred_k[9])
plot(cp_dlnm_5,"slice",var=pred_k[8])
plot(cp_dlnm_5,"slice",var=pred_k[7])
plot(cp_dlnm_5,"overall")
plot(cp_dlnm_10,"overall")
plot(cp_dlnm_005,"overall")
plot(cp_dlnm_0,"overall")
plot(cp_dlnm_who,"overall")
plot(cp_dlnm_epa,"overall")
cp_dlnm_00 <- crosspred(cb_dlnm, m3, cen = 0, at = pred_k, bylag = 0.2)
plot(cp_dlnm_00, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_00,"overall")
plot(cp_dlnm_5, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
##### Load DLNM results #####
load(paste0(dir_data, "analysis/gamns_dlnmlog35_comprisk_who-epa_contUSsamp_ADRD_any_pm25.rda"))
pm_dlnm <- cp_dlnm_005
pm_levs <- pred_k[c("10%", "25%", "50%", "75%", "90%", "epa_pm25", "pm25")]
load(paste0(dir_data, "analysis/gamns_dlnmlog35_comprisk_who-epa_contUSsamp_ADRD_any_no2.rda"))
no_dlnm <- cp_dlnm_005
no_levs <- pred_k[c("10%", "25%", "50%", "75%", "90%", "epa_no2", "no2")]
load(paste0(dir_data, "analysis/gamns_dlnmlog35_comprisk_who-epa_contUSsamp_ADRD_any_ozone.rda"))
oz_dlnm <- cp_dlnm_005
oz_levs <- pred_k[c("10%", "25%", "50%", "75%", "90%", "epa_ozone", "ozone")]
names(pm_levs) <- names(no_levs) <- names(oz_levs) <-
c("10%", "25%", "50%", "75%", "90%", "NAAQS", "AQG")
##### Create data table of results #####
lag_vals <- seq(1, 10, by = 0.2)
exp_dt <- rbindlist(list(
rbindlist(lapply(1:length(pm_levs), function(q) {
data.table(exp = "PM2.5",
lag = lag_vals,
quantile = names(pm_levs)[q],
val = pm_levs[q],
RR = pm_dlnm$matRRfit[paste0(pm_levs[q]),],
RRlow = pm_dlnm$matRRlow[paste0(pm_levs[q]),],
RRhigh = pm_dlnm$matRRhigh[paste0(pm_levs[q]),],
cumRR = pm_dlnm$allRRfit[paste0(pm_levs[q])],
cumRRlow = pm_dlnm$allRRlow[paste0(pm_levs[q])],
cumRRhigh = pm_dlnm$allRRhigh[paste0(pm_levs[q])])
})),
rbindlist(lapply(1:length(pm_levs), function(q) {
data.table(exp = "NO2",
lag = lag_vals,
quantile = names(no_levs)[q],
val = no_levs[q],
RR = no_dlnm$matRRfit[paste0(no_levs[q]),],
RRlow = no_dlnm$matRRlow[paste0(no_levs[q]),],
RRhigh = no_dlnm$matRRhigh[paste0(no_levs[q]),],
cumRR = no_dlnm$allRRfit[paste0(no_levs[q])],
cumRRlow = no_dlnm$allRRlow[paste0(no_levs[q])],
cumRRhigh = no_dlnm$allRRhigh[paste0(no_levs[q])])
})),
rbindlist(lapply(1:length(pm_levs), function(q) {
data.table(exp = "Summer Ozone",
lag = lag_vals,
quantile = names(oz_levs)[q],
val = oz_levs[q],
RR = oz_dlnm$matRRfit[paste0(oz_levs[q]),],
RRlow = oz_dlnm$matRRlow[paste0(oz_levs[q]),],
RRhigh = oz_dlnm$matRRhigh[paste0(oz_levs[q]),],
cumRR = oz_dlnm$allRRfit[paste0(oz_levs[q])],
cumRRlow = oz_dlnm$allRRlow[paste0(oz_levs[q])],
cumRRhigh = oz_dlnm$allRRhigh[paste0(oz_levs[q])])
}))))
##### DLNM Plot #####
exp_dt$exp <- factor(exp_dt$exp,
levels = c("PM2.5", "NO2", "Summer Ozone"))
ggplot(exp_dt[quantile != "NAAQS" & quantile != "AQG" & quantile != "10%"]) +
geom_hline(yintercept = 1, color = "black", size = 1) +
# geom_ribbon(aes(x = lag, ymin = RRlow, ymax = RRhigh, fill = quantile), alpha = 0.3) +
geom_line(aes(x = lag, y = RR, color = quantile, linetype = quantile), size = 2) +
facet_grid( ~ exp) +
theme_bw(base_size = 32) +
theme(legend.position = "bottom", legend.key.width = unit(1, "cm")) +
scale_x_continuous(breaks = 1:10, minor_breaks = NULL, expand = c(0.05, 0)) +
# scale_y_continuous(expand = c(0, 0), limits = c(0.96, 1.13)) +
labs(x = "Years prior", y = "Hazard odds",
color = "", linetype = "", fill = "") +
theme(legend.position = c(0.93, 0.82),
legend.background = element_blank(),
legend.key.height = unit(1, "cm"),
legend.key.width = unit(2.5, "cm"))
ggplot(exp_dt[quantile != "NAAQS" & quantile != "AQG"]) +
geom_hline(yintercept = 1, color = "black", size = 1) +
# geom_ribbon(aes(x = lag, ymin = RRlow, ymax = RRhigh, fill = quantile), alpha = 0.3) +
geom_line(aes(x = lag, y = RR, color = quantile, linetype = quantile), size = 2) +
facet_grid( ~ exp) +
theme_bw(base_size = 32) +
theme(legend.position = "bottom", legend.key.width = unit(1, "cm")) +
scale_x_continuous(breaks = 1:10, minor_breaks = NULL, expand = c(0.05, 0)) +
# scale_y_continuous(expand = c(0, 0), limits = c(0.96, 1.13)) +
labs(x = "Years prior", y = "Hazard odds",
color = "", linetype = "", fill = "") +
theme(legend.position = c(0.93, 0.82),
legend.background = element_blank(),
legend.key.height = unit(1, "cm"),
legend.key.width = unit(2.5, "cm"))
##### Cumulative effect plot #####
ggplot(exp_dt[lag == 1], aes(reorder_within(quantile, val, exp), cumRR,
ymin = cumRRlow, ymax = cumRRhigh)) +
geom_hline(yintercept = 1, color = "black", size = 1) +
geom_errorbar(width = 0.5, size = 2) +
# geom_errorbar(aes(x = quantile, ymin = cumRRlow, ymax = cumRRhigh), width = 0.5, size = 2) +
# geom_errorbar(data = exp_dt[lag == 1 & quantile == "NAAQS"],
#               aes(x = quantile, ymin = cumRRlow, ymax = cumRRhigh), width = 0.5, size = 2, color = "red") +
# geom_errorbar(data = exp_dt[lag == 1 & quantile == "AQG"],
#               aes(x = quantile, ymin = cumRRlow, ymax = cumRRhigh), width = 0.5, size = 2, color = "blue") +
geom_point(size = 3) +
# geom_point(aes(x = quantile, y = cumRR), size = 3) +
# geom_point(data = exp_dt[lag == 1 & quantile == "NAAQS"],
#            aes(x = quantile, y = cumRR), size = 3, color = "red") +
# geom_point(data = exp_dt[lag == 1 & quantile == "AQG"],
#            aes(x = quantile, y = cumRR), size = 3, color = "blue") +
# geom_text(data = exp_dt[lag == 1 & quantile == "AQG" & exp == "PM2.5"], aes(x = val, y = cumRR, label = quantile),
#           nudge_x = 0.1, nudge_y = 0.02, hjust = 0) +
# geom_text(data = exp_dt[lag == 1 & quantile == "NAAQS" & exp == "PM2.5"], aes(x = val, y = cumRR, label = quantile),
#           nudge_x = -0.1, nudge_y = 0.02, hjust = 1) +
# geom_text(data = exp_dt[lag == 1 & quantile == "AQG" & exp != "PM2.5"], aes(x = val, y = cumRR, label = quantile),
#           nudge_x = 0.5, nudge_y = 0.02, hjust = 0) +
# geom_text(data = exp_dt[lag == 1 & quantile == "NAAQS" & exp != "PM2.5"], aes(x = val, y = cumRR, label = quantile),
#           nudge_x = -0.5, nudge_y = 0.02, hjust = 1) +
facet_grid(~exp, scales = "free_x") +
scale_x_reordered() +
theme_bw(base_size = 32) +
labs(x = "Exposure concentration", y = "Cumulative hazard odds") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
plot(cp_dlnm_0, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
plot(cp_dlnm_005, "contour", main = exp, xlab = "Exposure concentration", ylab = "Years prior")
##### Cumulative effect plot #####
ggplot(exp_dt[lag == 1], aes(reorder_within(quantile, val, exp), cumRR,
ymin = cumRRlow, ymax = cumRRhigh)) +
geom_hline(yintercept = 1, color = "black", size = 1) +
geom_errorbar(width = 0.5, size = 2) +
geom_point(size = 3) +
facet_grid(~exp, scales = "free_x") +
scale_x_reordered() +
theme_bw(base_size = 32) +
labs(x = "Exposure concentration", y = "Cumulative hazard odds") +
theme(axis.text.x = element_text(angle = 90, hjust = 1))
load("/n/dominici_nsaph_l3/projects/air_pollution-distributed_lag_adrd/data/analysis/contUS_ADRD_any_hdlm_agg_fips.rda")
library(dlmtree)
load("/n/dominici_nsaph_l3/projects/air_pollution-distributed_lag_adrd/data/analysis/contUS_ADRD_any_hdlm_agg_fips.rda")
colMeans(hdlm$modCount > 0)
boxplot(hdlm$modInf)
hdlm$modPairs
boxplot(hdlm$termNodesMod)
boxplot(hdlm$termNodesDLM)
plotDLM <- function(estDLM_data) {
ggplot(estDLM_data$plotData) +
geom_hline(yintercept = 0, color = "red") +
geom_ribbon(aes(x = time, ymin = exp(lower)-1, ymax = exp(upper)-1), fill = "grey") +
geom_line(aes(x = time, y = exp(est)-1)) +
facet_wrap(~group) +
theme_bw() #+
#scale_x_reverse(breaks = 10:1, labels = 1:10)
}
##### Analysis #####
qid_dat_agg <- read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_qid_agg_fips_clean.fst"), as.data.table = TRUE)
##### Setup #####
AD_ADRD <- "ADRD" # AD or ADRD
code_type <- "any" # primary or any
n_threads = 2
Sys.setenv(OMP_NUM_THREADS = n_threads)
library(data.table)
library(fst)
library(ggplot2)
options(stringsAsFactors = FALSE)
setDTthreads(threads = n_threads)
threads_fst(n_threads)
dir_data <- "/n/home_fasse/dmork/projects/adrd_dlm/data/"
##### Analysis #####
qid_dat_agg <- read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_qid_agg_fips_clean.fst"), as.data.table = TRUE)
ageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1),
"80-84" = which(qid_dat_agg$age_cat == 2),
"85-89" = which(qid_dat_agg$age_cat == 3),
"90-94" = which(qid_dat_agg$age_cat == 4),
"95-99" = which(qid_dat_agg$age_cat == 5),
"100+" = which(qid_dat_agg$age_cat == 6)))
plotDLM(ageDLM)
raceDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("wht" = which(qid_dat_agg$race == "wht"),
"blk" = which(qid_dat_agg$race == "blk"),
"his" = which(qid_dat_agg$race == "his"),
"oth" = which(qid_dat_agg$race == "oth")))
plotDLM(raceDLM)
dualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any),
"not" = which(!qid_dat_agg$dual_any)))
plotDLM(dualDLM)
sexDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("M" = which(qid_dat_agg$sexM == 1),
"F" = which(qid_dat_agg$sexM == 0)))
plotDLM(sexDLM)
densDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("0-50" = which(qid_dat_agg$dens < 50),
"50-100" = which(qid_dat_agg$dens >= 50 & qid_dat_agg$dens < 100),
"100-500" = which(qid_dat_agg$dens >= 100 & qid_dat_agg$dens < 500),
"500+" = which(qid_dat_agg$dens >= 500)))
plotDLM(densDLM)
whtageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == "(74,79]" & qid_dat_agg$race == "wht"),
"80-84" = which(qid_dat_agg$age_cat == "(79,84]" & qid_dat_agg$race == "wht"),
"85-89" = which(qid_dat_agg$age_cat == "(84,89]" & qid_dat_agg$race == "wht"),
"90-94" = which(qid_dat_agg$age_cat == "(89,94]" & qid_dat_agg$race == "wht"),
"95-99" = which(qid_dat_agg$age_cat == "(94,99]" & qid_dat_agg$race == "wht"),
"99+" = which(qid_dat_agg$age_cat == "(99,200]" & qid_dat_agg$race == "wht")))
plotDLM(whtageDLM)
whtageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1 & qid_dat_agg$race == "wht"),
"80-84" = which(qid_dat_agg$age_cat == 2 & qid_dat_agg$race == "wht"),
"85-89" = which(qid_dat_agg$age_cat == 3 & qid_dat_agg$race == "wht"),
"90-94" = which(qid_dat_agg$age_cat == 4 & qid_dat_agg$race == "wht"),
"95-99" = which(qid_dat_agg$age_cat == 5 & qid_dat_agg$race == "wht"),
"99+" = which(qid_dat_agg$age_cat == 6 & qid_dat_agg$race == "wht")))
plotDLM(whtageDLM)
whtdualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any & qid_dat_agg$race == "wht"),
"not" = which(!qid_dat_agg$dual_any & qid_dat_agg$race == "wht")))
plotDLM(whtdualDLM)
blkdualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any & qid_dat_agg$race == "blk"),
"not" = which(!qid_dat_agg$dual_any & qid_dat_agg$race == "blk")))
plotDLM(blkdualDLM)
hisdualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any & qid_dat_agg$race == "his"),
"not" = which(!qid_dat_agg$dual_any & qid_dat_agg$race == "his")))
plotDLM(hisdualDLM)
plotDLM <- function(estDLM_data) {
ggplot(estDLM_data$plotData) +
geom_hline(yintercept = 0, color = "red") +
geom_ribbon(aes(x = time, ymin = (exp(lower)-1)*100, ymax = (exp(upper)-1)*100), fill = "grey") +
geom_line(aes(x = time, y = (exp(est)-1)*100)) +
facet_wrap(~group) +
theme_bw() +
scale_x_continuous(breaks = 1:10) +
labs(x = "Years Prior", y = "% change in Mortality Rate")
}
plotDLM(ageDLM)
ageDLM$n
##### Load relevant data #####
qid_dat <- read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_qid.fst"), as.data.table = TRUE)
pm25_dat <- read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_pm25.fst"), as.data.table = TRUE)
##### Restrict to complete follow-up 2010 through 2016, no deaths #####
idx <- which(rowSums(is.na(pm25_dat[, 11:20])) == 0 &
qid_dat$entry == 2000 & # follow up from 2000
qid_dat$year > 2009) # year 2010 and later for 10 lag years exposures
qid_dat <- qid_dat[idx]
pm25_dat <- pm25_dat[idx,]
##### Data fixes #####
qid_dat[, age_corrected := entry_age + year - entry]
qid_dat[, PIR := medianhousevalue/medhouseholdincome]
# clear missing data, zero exposure, infinite PIR
idx2 <- which(rowSums(pm25_dat[, 11:20] == 0) == 0 &
!is.infinite(qid_dat$PIR) &
qid_dat$age > 74 &
complete.cases(qid_dat[,.(year, age_corrected, dual, race, sexM,
region, statecode,
education, poverty, pct_blk, hispanic,
popdensity, pct_owner_occ, PIR)]))
qid_dat <- qid_dat[idx2]
pm25_dat <- pm25_dat[idx2,]
##### Remove QID after missing year of data #####
idx3 <- which(qid_dat$year == 2010)
qid_rm <- qid_dat[idx3, qid]
for (yr in 2011:2016) {
idx3 <- c(idx3, which(qid_dat$year == yr & qid_dat$qid %in% qid_rm))
qid_rm <- qid_dat[idx3][year == yr, qid]
}
qid_dat <- qid_dat[idx3]
pm25_dat <- pm25_dat[idx3,]
##### Only keep people who never moved ####
idx4 <- which(qid_dat$n_unique_zips == 1)
qid_dat <- qid_dat[idx4]
pm25_dat <- pm25_dat[idx4,]
rm(idx, idx2, idx3, idx4)
##### Merge PM/qid data #####
qid_dat <- merge(qid_dat, pm25_dat, by = c("qid", "year"))
rm(pm25_dat)
##### Create aggregated dataset #####
names(qid_dat)
##### Remove QID after missing year of data #####
idx3 <- which(qid_dat$year == 2010)
qid_rm <- qid_dat[idx3, qid]
for (yr in 2011:2016) {
idx3 <- c(idx3, which(qid_dat$year == yr & qid_dat$qid %in% qid_rm))
qid_rm <- qid_dat[idx3][year == yr, qid]
}
qid_dat <- qid_dat[idx3]
Q
qid_dat[,.N]
##### Create aggregated dataset #####
names(qid_dat)
qid_dat[, dual := dual == "1"]
qid_dat[, dual_any := any(dual), by = qid]
qid_dat[, age_cat := cut(age, breaks = c(74, 79, 84, 89, 94, 99, 200), labels = 1:6)]
qid_dat_agg <- qid_dat[,.(at_risk = .N, n_hosp = sum(first_hosp),
rate = sum(first_hosp) / (.N * (year - 2000)),
avg_age = mean(age),
his = mean(hispanic), blk = mean(pct_blk),
PIR = mean(PIR), pov = mean(poverty), ed = mean(education),
oo = mean(pct_owner_occ), dens = mean(popdensity),
s_tmmx = mean(summer_tmmx), w_tmmx = mean(winter_tmmx),
lat = mean(latitude), long = mean(longitude), region = first(region),
pm1 = mean(lag1), pm2 = mean(lag2), pm3 = mean(lag3),
pm4 = mean(lag4), pm5 = mean(lag5), pm6 = mean(lag4),
pm7 = mean(lag7), pm8 = mean(lag8), pm9 = mean(lag9),
pm10 = mean(lag10)),
by = .(year, statecode, sexM, age_cat, dual_any, race)]
qid_dat_agg[,.N]
qid_dat_agg[rate == 0, rate := min(qid_dat_agg$rate[qid_dat_agg$rate > 0]) / 2]
qid_dat_agg[, lograte := log(rate)]
hist(log(qid_dat_agg$at_risk))
hist(qid_dat_agg$lograte)
write_fst(qid_dat_agg, paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_qid_agg_state_clean.fst"))
library(dlmtree)
hist(as.matrix(qid_dat_agg[, paste0("pm", 1:10)]))
hdlm <- dlmtree(lograte ~ factor(age_cat) + sexM + dual_any +
factor(race) + factor(year) + factor(region) +
his + blk + PIR + pov + ed + oo + dens + avg_age + s_tmmx + w_tmmx,
data = qid_dat_agg,
exposure.data = as.matrix(qid_dat_agg[, paste0("pm", 1:10)]),
dlm.type = "nested",
tree.modifiers = c("sexM", "dual_any", "race", "age_cat", "dens"),
modifier.splits = 10,
n.trees = 10, n.burn = 500, n.iter = 1000, n.thin = 5,
tree.params.mod = c(.5, 4), tree.params.tdlm = c(.5, 4),
save.data = FALSE)
boxplot(hdlm$termNodesMod)
boxplot(hdlm$termNodesDLM)
colMeans(hdlm$modCount > 0)
boxplot(hdlm$modInf)
hdlm$modPairs
plotDLM <- function(estDLM_data) {
ggplot(estDLM_data$plotData) +
geom_hline(yintercept = 0, color = "red") +
geom_ribbon(aes(x = time, ymin = (exp(lower)-1)*100, ymax = (exp(upper)-1)*100), fill = "grey") +
geom_line(aes(x = time, y = (exp(est)-1)*100)) +
facet_wrap(~group) +
theme_bw() +
scale_x_continuous(breaks = 1:10) +
labs(x = "Years Prior", y = "% change in Mortality Rate")
}
ageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1),
"80-84" = which(qid_dat_agg$age_cat == 2),
"85-89" = which(qid_dat_agg$age_cat == 3),
"90-94" = which(qid_dat_agg$age_cat == 4),
"95-99" = which(qid_dat_agg$age_cat == 5),
"100+" = which(qid_dat_agg$age_cat == 6)))
plotDLM(ageDLM)
raceDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("wht" = which(qid_dat_agg$race == "wht"),
"blk" = which(qid_dat_agg$race == "blk"),
"his" = which(qid_dat_agg$race == "his"),
"oth" = which(qid_dat_agg$race == "oth")))
plotDLM(raceDLM)
dualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any),
"not" = which(!qid_dat_agg$dual_any)))
plotDLM(dualDLM)
sexDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("M" = which(qid_dat_agg$sexM == 1),
"F" = which(qid_dat_agg$sexM == 0)))
plotDLM(sexDLM)
head(as.matrix(qid_dat_agg[, paste0("pm", 1:10)]))
densDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("0-50" = which(qid_dat_agg$dens < 50),
"50-100" = which(qid_dat_agg$dens >= 50 & qid_dat_agg$dens < 100),
"100-500" = which(qid_dat_agg$dens >= 100 & qid_dat_agg$dens < 500),
"500+" = which(qid_dat_agg$dens >= 500)))
plotDLM(densDLM)
whtageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1 & qid_dat_agg$race == "wht"),
"80-84" = which(qid_dat_agg$age_cat == 2 & qid_dat_agg$race == "wht"),
"85-89" = which(qid_dat_agg$age_cat == 3 & qid_dat_agg$race == "wht"),
"90-94" = which(qid_dat_agg$age_cat == 4 & qid_dat_agg$race == "wht"),
"95-99" = which(qid_dat_agg$age_cat == 5 & qid_dat_agg$race == "wht"),
"99+" = which(qid_dat_agg$age_cat == 6 & qid_dat_agg$race == "wht")))
plotDLM(whtageDLM)
blkageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1 & qid_dat_agg$race == "blk"),
"80-84" = which(qid_dat_agg$age_cat == 2 & qid_dat_agg$race == "blk"),
"85-89" = which(qid_dat_agg$age_cat == 3 & qid_dat_agg$race == "blk"),
"90-94" = which(qid_dat_agg$age_cat == 4 & qid_dat_agg$race == "blk"),
"95-99" = which(qid_dat_agg$age_cat == 5 & qid_dat_agg$race == "blk"),
"99+" = which(qid_dat_agg$age_cat == 6 & qid_dat_agg$race == "blk")))
plotDLM(blkageDLM)
blkdualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any & qid_dat_agg$race == "blk"),
"not" = which(!qid_dat_agg$dual_any & qid_dat_agg$race == "blk")))
plotDLM(blkdualDLM)
hisageDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("75-79" = which(qid_dat_agg$age_cat == 1 & qid_dat_agg$race == "his"),
"80-84" = which(qid_dat_agg$age_cat == 2 & qid_dat_agg$race == "his"),
"85-89" = which(qid_dat_agg$age_cat == 3 & qid_dat_agg$race == "his"),
"90-94" = which(qid_dat_agg$age_cat == 4 & qid_dat_agg$race == "his"),
"95-99" = which(qid_dat_agg$age_cat == 5 & qid_dat_agg$race == "his"),
"99+" = which(qid_dat_agg$age_cat == 6 & qid_dat_agg$race == "his")))
plotDLM(hisageDLM)
hisdualDLM <- estDLM(hdlm, qid_dat_agg,
group.index = list("dual" = which(qid_dat_agg$dual_any & qid_dat_agg$race == "his"),
"not" = which(!qid_dat_agg$dual_any & qid_dat_agg$race == "his")))
plotDLM(hisdualDLM)
allDLM <- estDLM(hdlm, qid_dat_agg, group.index = list("all" = 1:qid_dat_agg[,.N]))
plotDLM(allDLM)
plotDLM <- function(estDLM_data) {
ggplot(estDLM_data$plotData) +
geom_hline(yintercept = 0, color = "red") +
geom_ribbon(aes(x = time, ymin = (exp(lower)-1)*100, ymax = (exp(upper)-1)*100), fill = "grey") +
geom_line(aes(x = time, y = (exp(est)-1)*100)) +
facet_wrap(~group) +
theme_bw() +
scale_x_continuous(breaks = 1:10) +
labs(x = "Years Prior", y = "% change in Hospitalization Rate")
}
plotDLM(allDLM)
pm25_dat <- read_fst(paste0(dir_data, "analysis/contUS_", AD_ADRD, "_",
code_type, "_pm25.fst"), as.data.table = TRUE)
head(pm25_dat)
head(pm25_dat[,11:20])
names(qid_dat)
